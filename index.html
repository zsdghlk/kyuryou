<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>給料計算ツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
<style>
  :root{
    --card-max: 760px; --gap: 12px; --radius: 14px; --bg: #f2f5f9;
    --c-plus:#2563eb; --c-minus:#0ea5e9; --c-reset:#dc2626; --c-save:#059669; --c-export:#7c3aed; --ink:#0b1020;
  }
  *{ box-sizing:border-box }
  html{ -webkit-text-size-adjust:100% }
  body{
    margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    background:var(--bg); min-height:100dvh; display:grid; place-items:center;
  }
  .card{
    width:min(96vw,var(--card-max)); background:#fff; border-radius:var(--radius);
    box-shadow:0 8px 24px rgba(0,0,0,.10); padding:clamp(14px,3.6vw,28px);
    padding-bottom:calc(clamp(14px,3.6vw,28px) + env(safe-area-inset-bottom));
    display:flex; flex-direction:column; gap:clamp(12px,2.6vw,20px);
  }
  .title{ margin:0; text-align:center; font-weight:700; font-size:clamp(18px,5.2vw,24px) }
  .status{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 12px; background:#f7f9fc; border:1px solid #e8eef7; border-radius:12px;
    font-size:clamp(16px,4.5vw,18px);
  }
  .status .value{ font-variant-numeric:tabular-nums; font-weight:700 }
  .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:var(--gap) }
  button{
    display:inline-flex; align-items:center; justify-content:center; width:100%; min-height:44px;
    padding:clamp(12px,3.2vw,16px); font-size:clamp(16px,4.6vw,18px); border:none; border-radius:12px; color:#fff;
    cursor:pointer; touch-action:manipulation; transition:transform .05s ease, filter .2s ease, background .2s ease;
  }
  button:active{ transform:scale(.98) }
  .plus{ background:var(--c-plus) } .minus{ background:var(--c-minus) } .reset{ background:var(--c-reset); grid-column:1/-1 }
  .save-btn{ background:var(--c-save) } .export-btn{ background:var(--c-export) }
  .salary{ margin-top:2px; padding:clamp(12px,3.2vw,16px); background:var(--ink); color:#fff; border-radius:12px;
    text-align:center; font-weight:800; font-size:clamp(20px,6.2vw,28px) }
  .save-row{ display:grid; gap:var(--gap); grid-template-columns:1fr }
  @media (min-width:520px){ .save-row{ grid-template-columns:1fr auto } }
  select{ width:100%; min-height:44px; padding:10px 12px; border-radius:10px; border:1px solid #dbe4f2; font-size:clamp(15px,4.5vw,16px); background:#fff }
  .months{ border-top:1px solid #e9eef6; padding-top:clamp(12px,2.6vw,18px); display:flex; flex-direction:column; gap:10px }
  .months h2{ margin:0; font-size:clamp(16px,4.5vw,18px); font-weight:700 }
  .months-grid{ display:grid; gap:10px; grid-template-columns:1fr }
  @media (min-width:420px){ .months-grid{ grid-template-columns:repeat(2,1fr) } }
  @media (min-width:720px){ .months-grid{ grid-template-columns:repeat(3,1fr) } }
  .month-item{ display:grid; grid-template-columns:auto 1fr; align-items:center; gap:8px; padding:10px; border:1px solid #e8eef7; border-radius:10px; background:#fbfdff; break-inside:avoid; page-break-inside:avoid }
  .month-label{ font-weight:600; color:#334155 }
  .month-input{ width:100%; border:none; background:transparent; text-align:right; font-size:clamp(15px,4.5vw,16px); color:#0b1220;
    padding:6px 8px; border-radius:8px; outline:none; font-variant-numeric:tabular-nums }
  .month-input::placeholder{ color:#94a3b8 }
  .note{ color:#64748b; font-size:clamp(12px,3.6vw,13px) }
  .total{ margin-top:12px; padding:clamp(12px,3.2vw,16px); background:#1e293b; color:#fff; border-radius:12px; text-align:center; font-weight:800; font-size:clamp(18px,5.5vw,24px) }
  .export-row{ display:grid; gap:var(--gap); margin-top:2px; grid-template-columns:repeat(2,minmax(0,1fr)) }
  @media (min-width:640px){ .export-row{ grid-template-columns:repeat(4,minmax(0,1fr)) } }
  @media print{
    body{ background:#fff } .card{ box-shadow:none; width:100%; max-width:none; padding:12mm; border-radius:0 }
    .grid{ grid-template-columns:1fr 1fr } .save-row{ grid-template-columns:1fr 1fr } .months-grid{ grid-template-columns:1fr 1fr 1fr }
    button,select{ display:none!important } .note{ color:#475569 }
  }
</style>
</head>
<body>
  <div class="card" id="capture-area">
    <h1 class="title">給料計算ツール</h1>

    <div class="status">
      <div>勤務日数</div>
      <div class="value"><span id="days">0</span> 日</div>
    </div>

    <div class="grid">
      <button class="plus"  onclick="addDay()">＋1日</button>
      <button class="minus" onclick="removeDay()">−1日</button>
      <button class="plus"  onclick="addMoney()">＋1300円</button>
      <button class="minus" onclick="removeMoney()">−1300円</button>
      <button class="reset" onclick="resetData()">リセット</button>
    </div>

    <div class="salary" id="salary">給料：0 円</div>

    <div class="save-row">
      <select id="monthSelect" aria-label="保存先の月">
        <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
        <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
        <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
        <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
      </select>
      <button class="save-btn" onclick="saveToSelectedMonth()">この金額を保存</button>
    </div>

    <section class="months">
      <h2>月別データ（1月〜12月）</h2>
      <div class="months-grid" id="monthsGrid"></div>
      <div class="note">数字はそのまま編集・削除できます（入力すると自動保存）。</div>
      <div class="total" id="totalYear">年間合計：0 円</div>
    </section>

    <div class="export-row">
      <button class="export-btn" onclick="printView()">印刷 / PDF保存</button>
      <button class="export-btn" onclick="exportCSV()">CSVダウンロード</button>
      <button class="export-btn" onclick="exportJSON()">JSONダウンロード</button>
      <button class="export-btn" onclick="exportPNG()">画像(PNG)保存</button>
    </div>
  </div>

<script>
(() => {
  // ===== 設定 =====
  const WAGE = 1300, BASE_HOURS = 7, EXTRA_STEP = 1300, STORAGE_KEY = 'salaryData_v4';
  let days = 0, extraMoney = 0, months = {};

  // ===== ユーティリティ =====
  const fmtJPY = n => Number(n||0).toLocaleString() + ' 円';
  const onlyDigits = s => (s||'').replace(/[^\d]/g, '');
  const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  function currentTotal(){ return (WAGE * BASE_HOURS * days) + extraMoney; }

  // ===== 表示更新 =====
  function render(){
    document.getElementById('days').textContent = days;
    document.getElementById('salary').textContent = '給料：' + fmtJPY(currentTotal());
  }

  // ===== 操作 =====
  function addDay(){ days++; render(); }
  function removeDay(){ if(days>0) days--; render(); }
  function addMoney(){ extraMoney += EXTRA_STEP; render(); }
  function removeMoney(){ if(extraMoney>=EXTRA_STEP) extraMoney -= EXTRA_STEP; render(); }
  function resetData(){ days = 0; extraMoney = 0; render(); }

  // ===== 月保存 =====
  function saveToSelectedMonth(){
    const sel = document.getElementById('monthSelect').value;
    months[sel] = currentTotal();
    saveMonths(); buildMonthsGrid();
  }

  // ===== 月一覧UI =====
  function buildMonthsGrid(){
    const grid = document.getElementById('monthsGrid');
    grid.innerHTML = '';
    let totalYear = 0;
    for(let m=1;m<=12;m++){
      const wrap = document.createElement('div'); wrap.className = 'month-item';
      const label = document.createElement('div'); label.className = 'month-label'; label.textContent = `${m}月`;
      const input = document.createElement('input');
      input.className = 'month-input'; input.setAttribute('data-month', m);
      input.setAttribute('placeholder','0'); input.setAttribute('inputmode','numeric'); input.setAttribute('aria-label', `${m}月の保存金額`);
      const val = months[m]||0; input.value = val ? Number(val).toLocaleString() : '';
      totalYear += months[m]||0;

      input.addEventListener('input', (e)=>{
        const raw = onlyDigits(e.target.value);
        e.target.value = raw;
        months[m] = raw===''?0:Number(raw);
        saveMonths(); updateTotal();
      });
      input.addEventListener('blur', (e)=>{
        const raw = onlyDigits(e.target.value);
        e.target.value = raw?Number(raw).toLocaleString():'';
      });
      input.addEventListener('focus', (e)=>{
        const raw = onlyDigits(e.target.value);
        e.target.value = raw;
        setTimeout(()=>{ const len=e.target.value.length; e.target.setSelectionRange(len,len); },0);
      });

      wrap.appendChild(label); wrap.appendChild(input); grid.appendChild(wrap);
    }
    document.getElementById('totalYear').textContent = '年間合計：' + fmtJPY(totalYear);
  }

  function updateTotal(){
    let sum=0; for(let m=1;m<=12;m++){ sum+=(months[m]||0); }
    document.getElementById('totalYear').textContent = '年間合計：' + fmtJPY(sum);
  }

  // ===== 保存／読込 =====
  function saveMonths(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(months)); }
  function loadMonths(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const obj = raw?JSON.parse(raw):{};
      months={}; for(let m=1;m<=12;m++){ months[m]=Number(obj[m]||0); }
    }catch(_){
      months={}; for(let m=1;m<=12;m++) months[m]=0;
    }
  }

  // ===== エクスポート（PDF/CSV/JSON） =====
  function printView(){ window.print(); }

  function exportCSV(){
    let rows = [];
    rows.push(['項目','値']);
    rows.push(['時給', WAGE]);
    rows.push(['基本勤務時間(時間/日)', BASE_HOURS]);
    rows.push(['現在の勤務日数', days]);
    rows.push(['現在の追加金額', extraMoney]);
    rows.push(['現在表示の給料', currentTotal()]);
    rows.push([]);
    rows.push(['月','金額']);
    let sum=0;
    for(let m=1;m<=12;m++){ const v=months[m]||0; rows.push([`${m}`, v]); sum+=v; }
    rows.push([]);
    rows.push(['年間合計', sum]);

    const csv = rows.map(r => r.map(x=>{
      const s = String(x ?? '');
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `salary_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function exportJSON(){
    const data = {
      wage: WAGE, baseHours: BASE_HOURS, days, extraMoney,
      currentTotal: currentTotal(), months,
      totalYear: Object.values(months).reduce((a,b)=>a+(b||0),0),
      generatedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `salary_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ===== 画像(PNG) — オフライン対応（SVG + foreignObject方式） =====
  function inlineComputedStyles(node){
    const win = node.ownerDocument.defaultView;
    const styles = win.getComputedStyle(node);
    const cssText = Array.from(styles).map(p => `${p}:${styles.getPropertyValue(p)}`).join(';');
    node.setAttribute('style', cssText);

    for (const child of node.children) inlineComputedStyles(child);
  }

  function exportPNG(){
    const el = document.getElementById('capture-area');
    const rect = el.getBoundingClientRect();
    const width = Math.ceil(rect.width);
    const height = Math.ceil(rect.height);

    // クローンしてスタイルをインライン化（外部CSS不要に）
    const clone = el.cloneNode(true);
    inlineComputedStyles(clone);

    // XHTMLシリアライズ
    const xhtml = new XMLSerializer().serializeToString(clone);

    // SVG＋foreignObjectでDOMを描画
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
        <foreignObject x="0" y="0" width="100%" height="100%">
          <div xmlns="http://www.w3.org/1999/xhtml">${xhtml}</div>
        </foreignObject>
      </svg>`.trim();

    const svgBlob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(url);
      const canvas = document.createElement('canvas');
      canvas.width = width * (window.devicePixelRatio || 1);
      canvas.height = height * (window.devicePixelRatio || 1);
      const ctx = canvas.getContext('2d');
      ctx.scale((window.devicePixelRatio || 1), (window.devicePixelRatio || 1));
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      const dataURL = canvas.toDataURL('image/png');

      // iOS/Safariは新規タブで開く
      if (isIOS || isSafari) {
        const w = window.open();
        if (w) {
          w.document.write('<html><head><title>salary.png</title></head><body style="margin:0"><img src="'+dataURL+'" style="width:100%;height:auto"/></body></html>');
          w.document.close();
        } else {
          const a = document.createElement('a'); a.href = dataURL; a.target = '_blank'; document.body.appendChild(a); a.click(); a.remove();
        }
      } else {
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = `salary_${new Date().toISOString().slice(0,10)}.png`;
        document.body.appendChild(a); a.click(); a.remove();
      }
    };
    img.onerror = () => {
      alert('画像変換に失敗しました。お手数ですが「印刷 / PDF保存」をご利用ください。');
      URL.revokeObjectURL(url);
    };
    img.src = url;
  }

  // ===== 初期化 =====
  (function init(){
    document.getElementById('monthSelect').value = String(new Date().getMonth()+1);
    loadMonths(); buildMonthsGrid(); render();
  })();

  // iOS ピンチズーム抑止（補助）
  document.addEventListener('gesturestart', e => e.preventDefault(), {passive:false});

  // 公開
  window.addDay = addDay; window.removeDay = removeDay;
  window.addMoney = addMoney; window.removeMoney = removeMoney;
  window.resetData = resetData; window.saveToSelectedMonth = saveToSelectedMonth;
  window.printView = printView; window.exportCSV = exportCSV;
  window.exportJSON = exportJSON; window.exportPNG = exportPNG;
})();
</script>
</body>
</html>